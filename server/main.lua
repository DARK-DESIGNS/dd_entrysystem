--███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--
--█░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░██░░░░░░░░████░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█--
--█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░██░░▄▀▄▀░░████░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░░░░░░░░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░██░░▄▀░░░░████░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░░░▄▀░░░░█░░▄▀░░░░░░░░░░█░░▄▀▄▀▄▀▄▀▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░██░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░███████████░░▄▀░░███░░▄▀░░█████████░░▄▀░░░░░░▄▀░░██░░▄▀░░█░░▄▀░░█████████--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░███░░▄▀░░██░░░░░░█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░███░░▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░░░░░░░░░▄▀░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░██░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████████████░░▄▀░░███░░▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░▄▀░░█████████░░▄▀░░█--
--█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░░░████░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░█░░░░▄▀░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀▄▀▄▀░░█░░░░░░░░░░▄▀░░█--
--█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀░░████░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░░░░░░░░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░░░░░░░░░░░███░░░░░░██░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░██░░░░░░░░████░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█--
--███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--

RegisterServerEvent('dd_entrysystem:whitelistStatus', function()
    local CitizenID = GetPlayerIdentifier(source)

    MySQL.insert('INSERT IGNORE INTO `dd_entrysystem` (`characterid`, `whitelisted`) VALUES (?, ?)',
    {CitizenID, "false"},
    function()
    	print(CitizenID .. " player has succesfully loaded in the DB")
    end)

    MySQL.Async.fetchAll('SELECT * FROM `dd_entrysystem` WHERE `characterid` = ?',
    {CitizenID},
    function(result)
        local whitelistResult = result[1].whitelisted

        if not whitelistResult == "true" and not whitelistResult == "false" then
            local whitelistResult2 = false
            TriggerClientEvent('dd_entrysystem:setWhitelistStatus', -1, whitelistResult2)
        else
            TriggerClientEvent('dd_entrysystem:setWhitelistStatus', -1, whitelistResult)
        end
    end)
    
end)

RegisterServerEvent("dd_entrysystem:newentry", function(playerid, setentry)
    local CitizenID = GetPlayerIdentifier(playerid)
    local whitelistStatus = setentry
    local source = source
    if CitizenID == nil then
        TriggerClientEvent('qb-core:client:DrawText', source, Config.wrongID, 'left')
                Wait(8000)
                TriggerClientEvent('qb-core:client:HideText', source)
    else
        if IsPlayerAceAllowed(source, "dd_entrysystem") then
            if whitelistStatus == "true" or whitelistStatus == "false" then
                MySQL.update('UPDATE `dd_entrysystem` SET `whitelisted` = ? WHERE `characterid` = ?', 
                {whitelistStatus, CitizenID},

                function()
                    TriggerClientEvent('qb-core:client:DrawText', source, "Whiteliststatus: " .. whitelistStatus .. " has been set for: " .. CitizenID, 'left')
                    Wait(8000)
                    TriggerClientEvent('qb-core:client:HideText', source)
                end)

            else
                TriggerClientEvent('qb-core:client:DrawText', source, "ERROR", 'left')
                    Wait(8000)
                    TriggerClientEvent('qb-core:client:HideText', source)
                return
            end
        else
            TriggerClientEvent('qb-core:client:DrawText', source, Config.noPermission, 'left')
                    Wait(5000)
                    TriggerClientEvent('qb-core:client:HideText', source)
        end
        print("Player with the license: " .. CitizenID .. " has a new whiteliststatus: " .. whitelistStatus)
    end
end)

RegisterCommand("joinentry", function(source)
    if IsPlayerAceAllowed(source, "dd_entrysystem") then
        local data = check
        TriggerClientEvent("dd_entrysystem:joinentry",source, data)
    end
end)

RegisterServerEvent("dd_entrysystem:nuiCallback", function(source)
    if IsPlayerAceAllowed(source, "dd_entrysystem") then
        
    end
end)

RegisterServerEvent("dd_entrysystem:webhook", function(serverId)
    local url = Config.url
    local image = "https://i.imgur.com/ojnT8YE.png"
    local author = "dd_entrysystem"
    local text = Config.webhookText.eins .. GetPlayerName(source) .. Config.webhookText.zwei .. serverId .. Config.webhookText.drei

    PerformHttpRequest(url, function(error, text, header)
    end,
    'POST',
    json.encode({username = author, content = text, avatar_url = image,}), {["Content-Type"] = 'application/json'})
end)